---
- name: ğŸŸ¢ å®‰è£ K3s master ä¸¦æº–å‚™ kubeconfig èˆ‡ Helm
  hosts: k3s_master
  become: true
  gather_facts: false
  vars:
    ansible_user: ubuntu
  tasks:
    - name: å®‰è£ K3s master
      shell: curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--tls-san {{ ansible_host }}" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: è®€å– node-token
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: node_token

    - name: è¨­å®š token fact çµ¦ agent ä½¿ç”¨
      add_host:
        name: k3s_master
        ansible_host: "{{ inventory_hostname }}"
        k3s_token: "{{ node_token.stdout }}"
        ansible_user: "{{ ansible_user }}"
        ansible_ssh_private_key_file: "{{ ansible_ssh_private_key_file | default(omit) }}"

    - name: å»ºç«‹ ~/.k3s ç›®éŒ„
      become: false
      file:
        path: "/home/{{ ansible_user }}/.k3s"
        state: directory
        mode: "0755"

    - name: è¤‡è£½ kubeconfig åˆ°ä½¿ç”¨è€…ç›®éŒ„
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "/home/{{ ansible_user }}/.k3s/k3s.yaml"
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: è¨­å®š KUBECONFIG ç’°å¢ƒè®Šæ•¸
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "export KUBECONFIG=$HOME/.k3s/k3s.yaml"
        state: present
      become: false

    - name: åŠ å…¥ kubectl è‡ªå‹•è£œå®Œ
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "source <(kubectl completion bash)"
        state: present
      become: false

    - name: åŠ å…¥ kubectl alias ç‚º k
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "alias k=kubectl"
        state: present
      become: false

    - name: åŠ å…¥ alias è‡ªå‹•è£œå®Œ
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "complete -F __start_kubectl k"
        state: present
      become: false

    - name: é¡¯ç¤ºæ‰€æœ‰ Pod ç‹€æ…‹
      shell: kubectl get pod -A
      environment:
        KUBECONFIG: "/home/{{ ansible_user }}/.k3s/k3s.yaml"
      register: pods_output
      changed_when: false

    - name: å®‰è£ Helm
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: åŠ å…¥ Elastic Helm repo
      shell: helm repo add elastic https://helm.elastic.co
      args:
        creates: /home/{{ ansible_user }}/.cache/helm/repository/elastic-index.yaml
      become: false

    - name: æ›´æ–° Helm repo
      shell: helm repo update
      become: false

- name: ğŸŸ¡ å®‰è£ K3s agents ä¸¦åŠ å…¥ cluster
  hosts: k3s_worker
  become: true
  gather_facts: false
  vars:
    k3s_url: "https://{{ hostvars['k3s_master'].ansible_host }}:6443"
  tasks:
    - name: ğŸ” é¡¯ç¤º master IP èˆ‡ token
      debug:
        msg: "URL: {{ k3s_url }}, Token: {{ hostvars['k3s_master'].k3s_token }}"

    - name: è¨­å®š agent ç”¨çš„ K3S_TOKEN
      set_fact:
        k3s_token: "{{ hostvars['k3s_master'].k3s_token }}"

    - name: Debug æª¢æŸ¥è®Šæ•¸
      debug:
        msg: "Connecting to {{ k3s_url }} using token {{ k3s_token }}"

    - name: å®‰è£ K3s agent ä¸¦åŠ å…¥ master
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL={{ k3s_url }} K3S_TOKEN={{ k3s_token }} sh -
      register: install_output
      changed_when: true

    - name: é¡¯ç¤º worker å®‰è£è¼¸å‡º
      debug:
        var: install_output.stdout_lines

    - name: é¡¯ç¤º k3s-agent æœå‹™æœ€è¿‘æ—¥èªŒ
      shell: journalctl -u k3s-agent --no-pager -n 20
      register: agent_logs
      changed_when: false

    - name: è¼¸å‡ºæ—¥èªŒ
      debug:
        var: agent_logs.stdout_lines
